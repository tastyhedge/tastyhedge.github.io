<!DOCTYPE html>
<html lang="en-US">

<head>
  <title>How-To Calibrate American Options Really Fast | TastyHedge</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Oleksandr Gituliar">
  <meta name="description"
    content="In this post, you will learn how to calibrate American options in C&#43;&#43; with modern methods and open-source tools, so that calibration will be really fast with source code open to review.
Source code itself is located in gituliar/tastyhedge repo on GitHub, which you can build and run it on Linux or Windows. This repo also contains all necessary market data to reproduce discussed examples.
Calibration is a process of fitting parameters of the model to the market data." />

  
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HZRVS8S0KQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-HZRVS8S0KQ');
  </script>
  

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/code.css">
  <link rel="icon" href="/favicon.ico">

  <meta property="og:title" content="How-To Calibrate American Options Really Fast" />
<meta property="og:description" content="In this post, you will learn how to calibrate American options in C&#43;&#43; with modern methods and open-source tools, so that calibration will be really fast with source code open to review.
Source code itself is located in gituliar/tastyhedge repo on GitHub, which you can build and run it on Linux or Windows. This repo also contains all necessary market data to reproduce discussed examples.
Calibration is a process of fitting parameters of the model to the market data." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://tastyhedge.com/blog/how-to-calibrate-american-options-really-fast/" /><meta property="og:image" content="https://tastyhedge.com/blog/how-to-calibrate-american-options-really-fast/cover.webp" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2024-02-26T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-02-26T00:00:00+00:00" />



  
</head>

<body class="mx-auto bg-stone-200">
  <div class="bg-white pb-1 min-h-screen px-4 md:px-12 border-x-[1px] border-black">
    <nav class="flex justify-between pb-6">
      <a class="block font-bold my-auto text-2xl tracking-tighter text-inherit no-underline"
        style="text-underline-offset: 6px;" href="/">
        <img src="/img/logo/logo-32x32.png" class="inline-flex py-4 me-2 w-8"><span
          class="align-middle">TastyHedge</span>
      </a>
      <div class=" my-auto text-xl">
        <a class="text-black" href="/about">About</a>
      </div>
    </nav>

    

<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <img class="pb-4" alt="Title image" src="cover.webp" />
    

    <p class="mb-0 flex justify-between">
      <span class="my-auto">
        <time class="dt-published" datetime='2024-02-26 00:00:00 &#43;0000 UTC' itemprop="datePublished">
          2024-02-26
        </time>
        â€”
        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a href="/about" itemprop="name">Oleksandr Gituliar</a></span>
      </span>
      <span>
        Follow on
        <a href="https://www.linkedin.com/mynetwork/discovery-see-all/?usecase=PEOPLE_FOLLOWS&followMember=gituliar"
          target="_blank" title="LinkedIn" class="social-media no-underline">
          <img src="/img/brands/linkedin.svg" />
        </a>
        <a href="https://github.com/gituliar" target="_blank" title="GitHub" class="social-media no-underline">
          <img src="/img/brands/github.svg" />
        </a>
        
      </span>
    </p>
  </header>

  <div class="article-body" itemprop="articleBody">
    <p><strong>In this post</strong>, you will learn how to calibrate American options in C++ with modern methods and
open-source tools, so that calibration will be really fast with source code open to review.</p>
<p><strong>Source code</strong> itself is located in <a href="https://github.com/gituliar/tastyhedge">gituliar/tastyhedge</a>
repo on GitHub, which you can build and run it on Linux or Windows. This repo also contains all
necessary market data to reproduce discussed examples.</p>
<p><strong>Calibration</strong> is a process of fitting parameters of the model to the market data. The model itself
is used to quantify risks due to the market moves. This is an inevitable step in building advanced
hedging and trading strategies.</p>
<p><strong>Black-Scholes model</strong> with early exercise is our main focus. It&rsquo;s suitable for pricing equity
options, which are mostly of American style. Models with the early-exercise feature have no
analytical solution and usually are solved with time-consuming numerical methods. We&rsquo;ll use a
<a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2547027">boundary-interpolation</a> method, which
is available in
<a href="https://hpcquantlib.wordpress.com/2022/10/09/high-performance-american-option-pricing/">QuantLib</a>.
This modern method is very fast and is essential for anyone interested in quantitative finance.</p>
<p><strong>In my previous post</strong>, I discussed in details another method for pricing American options &ndash;
<a href="/blog/finite-difference-americans">finite-difference</a> method. This method is much slower, however
more universal and can be used to solve a broader range of problems, similar to Monte-Carlo. Every
seasoned quant I met is familiar with this method.</p>
<h2 id="introduction">Introduction</h2>
<p><strong>Trading options</strong> is possible without a risk management strategy. You don&rsquo;t necessary need to
understand a pricing model and all risk measures it calculates (like delta, vega, gamma, etc.).
Option prices are available in the trading app that is provided by your broker. You can buy or even
sell options pretty much like you do with stocks.</p>
<p><strong>A naive approach</strong> like this, will eventually lead to a disaster very soon. Hence, if your
intention goes beyond betting on a stock market with options, you&rsquo;d better hedge your portfolio and
keep under control your risk limits.</p>
<p><strong>Volatility</strong> is the only parameter of the Black-Scholes model. We consider to use this model for
risk management as option prices alone can&rsquo;t quantify the market risk. Your broker will likely
provide implied volatility data.</p>
<h2 id="prerequisite">Prerequisite</h2>
<p><strong>Imagine for a moment</strong> that we want to run a brokerage business. Apart from the main service &ndash; to
execute client orders &ndash; we also want to provide volatility data, so that our clients can manage
risk of their positions and survive in the whirl of the financial markets. In addition, we might
consider to manage market risk of our own positions if we decide to take some risk too.</p>
<p><strong>Market data</strong> is provided by the exchange. This includes option prices, volume, open interest,
etc. Perfectly, we&rsquo;d like to get this data in real-time, however for the calibration exercise we are
fine with historical data.</p>
<p><strong>Tesla</strong> is good candidates to test our approach. It is liquid and pays no dividends, which
simplifies the calibration process. As a dataset, let&rsquo;s take Tesla options on 2023-05-01 with a
5-min interval. There are 3'634 options in every snapshot or, 283'360 options in total.</p>
<p><strong>Interest rate</strong> is another input to the Black-Scholes model. Its origin largely depends on how we
going to hedge the interest-rate risk. As this is not our main focus for the moment, let&rsquo;s take
freely available
<a href="https://home.treasury.gov/resource-center/data-chart-center/interest-rates/TextView?type=daily_treasury_yield_curve">Daily Treasury Par Yield Curve Rates</a>
from the U.S. Treasury.</p>
<p><strong>The dataset</strong> with all mentioned market data is located in
<a href="https://github.com/gituliar/tastyhedge/tree/main/mds">gituliar/tastyhedge/mds</a>.</p>
<p><strong>Risk analytics</strong> is the last piece we need to run our brokerage firm. This sort of programs is
proprietary and expensive, however we can build it ourselves. After all, that&rsquo;s what this post is
about, so let&rsquo;s dive in.</p>
<h2 id="step-1-european-calibration">Step 1: European Calibration</h2>
<p><strong>The first step</strong> in our approach is to calibrate European options. The idea is to start with the
European volatility and adjust it repeatedly until it replicates the American price. For more
details see Step 3.</p>
<p><strong>European calibration</strong> has no closed-form solution. Fortunately, there is a very efficient
numerical algorithm: <a href="http://www.jaeckel.org/">Let&rsquo;s Be Rational</a> by Peter Jaeckel. Its reference
implementation is available in C++ and other languages. We will use it like this:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#09f;font-style:italic">/// File: src/Analytics/Model_BlackScholes.cpp
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#09f;font-style:italic"></span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>Error
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="color:#c0f">calibrateEuropean</span>(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>  f64    v,     <span style="color:#09f;font-style:italic">//  option price
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="color:#09f;font-style:italic"></span>  f64    s,     <span style="color:#09f;font-style:italic">//  stock price
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style="color:#09f;font-style:italic"></span>  f64    k,     <span style="color:#09f;font-style:italic">//  strike
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span><span style="color:#09f;font-style:italic"></span>  f64    dte,   <span style="color:#09f;font-style:italic">//  days to expiration
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style="color:#09f;font-style:italic"></span>  f64    r,     <span style="color:#09f;font-style:italic">//  interest rate
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#09f;font-style:italic"></span>  f64    q,     <span style="color:#09f;font-style:italic">//  dividend rate
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style="color:#09f;font-style:italic"></span>  Parity w,     <span style="color:#09f;font-style:italic">//  put / call
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span><span style="color:#09f;font-style:italic"></span>  f64<span style="color:#555">&amp;</span>   z)     <span style="color:#09f;font-style:italic">//  implied volatility
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span><span style="color:#09f;font-style:italic"></span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>  f64 t <span style="color:#555">=</span> dte <span style="color:#555">/</span> kDaysInYear;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>  f64 k_ <span style="color:#555">=</span> k <span style="color:#555">*</span> exp(<span style="color:#555">-</span>t <span style="color:#555">*</span> r);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>  z <span style="color:#555">=</span> implied_volatility_from_a_transformed_rational_guess(v, s, k_, t, w);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>  <span style="color:#069;font-weight:bold">return</span> <span style="color:#c30">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>}
</span></span></code></pre></div><h3 id="performance">Performance</h3>
<p><strong>2'800'000 opt/s</strong> is how many European options I&rsquo;m able to calibrate on my machine with AMD Ryzen
9 CPU. You may wonder whether this is a lot or not ?</p>
<p><strong>The options market</strong> has about 1'500'000 options listed on 5'000 stocks. Hence, we can calibrate
the entire market in just 1/2 of a second on a single CPU core. Of course, this is not a nanosecond
scale, required for high-frequency trading, however it&rsquo;s more than enough for most hedging and
trading strategies.</p>
<p><strong>Advanced statistic</strong> with per-call distribution time of <code>calibrateEuropean</code>, collected with
<a href="https://github.com/wolfpld/tracy">Tracy</a> profiler, looks as following:</p>
<p><img src="calibrateEuropean.webp" alt="Step 1: Statistics"></p>
<h2 id="step-2-american-pricing">Step 2: American Pricing</h2>
<p><strong>The second step</strong> is to adjust our initial estimate to a desired tolerated error. You&rsquo;ll see how
to do this in the next step. For now we need to learn how to efficiently price American options.</p>
<p><strong>American pricing</strong> is costly because of the early-exercise feature. Fortunately, there is a modern
<a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2547027">boundary-interpolation</a> method by
Andersen et al. It&rsquo;s available in
<a href="https://hpcquantlib.wordpress.com/2022/10/09/high-performance-american-option-pricing/">QuantLib</a>
and is probably the fastest method to price American options.</p>
<p><strong>QuantLib</strong> is an advanced library with many features, so we need to perform some preparation steps
prior to calling the pricing algorithm:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#09f;font-style:italic">/// File: src/Analytics/Model_BlackScholes.cpp
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#09f;font-style:italic"></span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>Error
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="color:#c0f">priceAmerican</span>(f64 s, f64 k, f64 dte, f64 z, f64 r, f64 q, Parity w, f64<span style="color:#555">&amp;</span> v)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>  <span style="color:#09f;font-style:italic">/// Anchor + Maturity
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#09f;font-style:italic">///
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#069;font-weight:bold">auto</span> anchor <span style="color:#555">=</span> ql<span style="color:#555">::</span>Date(<span style="color:#f60">31</span>, ql<span style="color:#555">::</span>Jul, <span style="color:#f60">1944</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>  <span style="color:#069;font-weight:bold">auto</span> act365 <span style="color:#555">=</span> ql<span style="color:#555">::</span>Actual365Fixed();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>  <span style="color:#069;font-weight:bold">auto</span> maturity <span style="color:#555">=</span> anchor <span style="color:#555">+</span> std<span style="color:#555">::</span>ceil(dte);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>  ql<span style="color:#555">::</span>Settings<span style="color:#555">::</span>instance().evaluationDate() <span style="color:#555">=</span> anchor;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>  <span style="color:#09f;font-style:italic">/// Option Data
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#09f;font-style:italic">///
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span><span style="color:#09f;font-style:italic"></span>  ql<span style="color:#555">::</span>Option
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>    w_ <span style="color:#555">=</span> (w <span style="color:#555">==</span> kParity_Call) <span style="color:#555">?</span> ql<span style="color:#555">::</span>Option<span style="color:#555">::</span><span style="color:#99f">Call</span> : ql<span style="color:#555">::</span>Option<span style="color:#555">::</span>Put;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>  ql<span style="color:#555">::</span>Handle<span style="color:#555">&lt;</span>ql<span style="color:#555">::</span>YieldTermStructure<span style="color:#555">&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>    r_ <span style="color:#555">=</span> make_shared<span style="color:#555">&lt;</span>ql<span style="color:#555">::</span>FlatForward<span style="color:#555">&gt;</span>(anchor, r, act365);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>  ql<span style="color:#555">::</span>Handle<span style="color:#555">&lt;</span>ql<span style="color:#555">::</span>YieldTermStructure<span style="color:#555">&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>    q_ <span style="color:#555">=</span> make_shared<span style="color:#555">&lt;</span>ql<span style="color:#555">::</span>FlatForward<span style="color:#555">&gt;</span>(anchor, q, act365);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>  ql<span style="color:#555">::</span>Handle<span style="color:#555">&lt;</span>ql<span style="color:#555">::</span>Quote<span style="color:#555">&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>    s_ <span style="color:#555">=</span> make_shared<span style="color:#555">&lt;</span>ql<span style="color:#555">::</span>SimpleQuote<span style="color:#555">&gt;</span>(s);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>  ql<span style="color:#555">::</span>Handle<span style="color:#555">&lt;</span>ql<span style="color:#555">::</span>BlackVolTermStructure<span style="color:#555">&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>    z_ <span style="color:#555">=</span> make_shared<span style="color:#555">&lt;</span>ql<span style="color:#555">::</span>BlackConstantVol<span style="color:#555">&gt;</span>(anchor, ql<span style="color:#555">::</span>TARGET(), z, act365);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>  <span style="color:#09f;font-style:italic">/// Black-Scholes Model
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#09f;font-style:italic">///
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#069;font-weight:bold">auto</span> bsm <span style="color:#555">=</span> make_shared<span style="color:#555">&lt;</span>ql<span style="color:#555">::</span>BlackScholesMertonProcess<span style="color:#555">&gt;</span>(s_, q_, r_, z_);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>  <span style="color:#069;font-weight:bold">auto</span> engine <span style="color:#555">=</span> make_shared<span style="color:#555">&lt;</span>ql<span style="color:#555">::</span>QdFpAmericanEngine<span style="color:#555">&gt;</span>(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>    bsm, ql<span style="color:#555">::</span>QdFpAmericanEngine<span style="color:#555">::</span>fastScheme());
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>  <span style="color:#069;font-weight:bold">auto</span> payoff <span style="color:#555">=</span> make_shared<span style="color:#555">&lt;</span>ql<span style="color:#555">::</span>PlainVanillaPayoff<span style="color:#555">&gt;</span>(w_, k);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>  <span style="color:#069;font-weight:bold">auto</span> americanExercise <span style="color:#555">=</span> make_shared<span style="color:#555">&lt;</span>ql<span style="color:#555">::</span>AmericanExercise<span style="color:#555">&gt;</span>(anchor, maturity);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>  ql<span style="color:#555">::</span>VanillaOption americanOption(payoff, americanExercise);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>  americanOption.setPricingEngine(engine);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span>  <span style="color:#09f;font-style:italic">/// Boundary-Interpolation Pricer
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#09f;font-style:italic">///
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#069;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span>      v <span style="color:#555">=</span> americanOption.NPV();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span>  }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span>  <span style="color:#09f;font-style:italic">/// Error Handling
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#09f;font-style:italic">///
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#069;font-weight:bold">catch</span> (...) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span><span>      std<span style="color:#555">::</span>exception_ptr ep <span style="color:#555">=</span> std<span style="color:#555">::</span>current_exception();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span><span>      <span style="color:#069;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span><span>          std<span style="color:#555">::</span>rethrow_exception(ep);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span><span>      }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span><span>      <span style="color:#069;font-weight:bold">catch</span> (std<span style="color:#555">::</span>exception<span style="color:#555">&amp;</span> e) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span><span>          <span style="color:#069;font-weight:bold">return</span> <span style="color:#c30">&#34;priceAmerican : &#34;</span>s <span style="color:#555">+</span> e.what();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span><span>      }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span><span>  }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span><span>  <span style="color:#069;font-weight:bold">return</span> <span style="color:#c30">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span><span>}
</span></span></code></pre></div><h3 id="performance-1">Performance</h3>
<p><strong>45'000 opt/s</strong> is how many American options I can price on the same machine. It&rsquo;s not as
impressive as 2'800'000 opt/s for European calibration. But it&rsquo;s about 100x faster than pricing with
the finite-difference method. See my post on
<a href="blog/pricing-derivatives-on-a-budget/">pricing American options on CPU and GPU</a> for detailed
benchmarks.</p>
<p><strong>Advanced statistic</strong> with per-call distribution time of <code>priceAmerican</code>, collected with
<a href="https://github.com/wolfpld/tracy">Tracy</a> profiler, looks as following:</p>
<p><img src="priceAmerican.webp" alt="Step 2: Statistics"></p>
<h2 id="step-3-american-calibration">Step 3: American Calibration</h2>
<p><strong>The third step</strong>, and the final one, is to adjust our initial estimate repeatedly until it
replicates the American price to the desired tolerance. As option prices are quoted with $0.01 step,
we can safely tolerate the error within that range.</p>
<p><strong><a href="https://en.wikipedia.org/wiki/Newton%27s_method">Newton&rsquo;s</a> method</strong> is a classical algorithm to
numerically find roots of a real-valued function. In our case, the function is a difference between
the model and market prices of the option, while unknown variable is implied volatility.</p>
<p>The final implementation looks as:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#09f;font-style:italic">/// File: src/Analytics/Model_BlackScholes.cpp
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#09f;font-style:italic"></span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>Error
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="color:#c0f">calibrateAmerican</span>(f64 v, f64 s, f64 k, f64 dte, f64 r, f64 q, Parity w, f64<span style="color:#555">&amp;</span> z)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>  Error err;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>  <span style="color:#09f;font-style:italic">/// Initial guess
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#09f;font-style:italic">///
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#069;font-weight:bold">if</span> (<span style="color:#069;font-weight:bold">auto</span> err <span style="color:#555">=</span> calibrateEuropean(v, s, k, dte, r, q, w, z); <span style="color:#555">!</span>err.empty())
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>    <span style="color:#069;font-weight:bold">return</span> <span style="color:#c30">&#34;calibrateAmerican : &#34;</span> <span style="color:#555">+</span> err;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>  <span style="color:#09f;font-style:italic">/// Newton&#39;s solver
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#09f;font-style:italic">///
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span><span style="color:#09f;font-style:italic"></span>  f64 v_ <span style="color:#555">=</span> v;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>  s16 n <span style="color:#555">=</span> <span style="color:#f60">16</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>  <span style="color:#069;font-weight:bold">while</span> (n<span style="color:#555">--</span> <span style="color:#555">&gt;</span> <span style="color:#f60">0</span> <span style="color:#555">&amp;&amp;</span> <span style="color:#555">!</span>std<span style="color:#555">::</span>isnan(z)) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>    <span style="color:#069;font-weight:bold">if</span> (<span style="color:#069;font-weight:bold">auto</span> err <span style="color:#555">=</span> priceAmerican(s, k, dte, z, r, q, w, v_); <span style="color:#555">!</span>err.empty())
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>      <span style="color:#069;font-weight:bold">return</span> <span style="color:#c30">&#34;calibrateAmerican : &#34;</span> <span style="color:#555">+</span> err;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>    <span style="color:#069;font-weight:bold">if</span> (std<span style="color:#555">::</span>isnan(v))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>      <span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>    <span style="color:#069;font-weight:bold">const</span> f64 tolerance <span style="color:#555">=</span> <span style="color:#f60">0.005</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>    <span style="color:#069;font-weight:bold">if</span> (std<span style="color:#555">::</span>abs(v <span style="color:#555">-</span> v_) <span style="color:#555">&lt;</span> tolerance)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>      <span style="color:#09f;font-style:italic">/// Solution found
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span><span style="color:#09f;font-style:italic"></span>      <span style="color:#069;font-weight:bold">return</span> <span style="color:#c30">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>    <span style="color:#09f;font-style:italic">/// Boundary-Interpolation Pricer
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">///
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span><span style="color:#09f;font-style:italic"></span>    f64 vUp;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>    <span style="color:#069;font-weight:bold">const</span> f64 dz <span style="color:#555">=</span> <span style="color:#f60">0.0001</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>    <span style="color:#069;font-weight:bold">if</span> (err <span style="color:#555">=</span> priceAmerican(s, k, dte, z <span style="color:#555">+</span> dz, r, q, w, vUp); <span style="color:#555">!</span>err.empty())
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>      <span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>    <span style="color:#09f;font-style:italic">/// Finite-difference derivative
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">///
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span><span style="color:#09f;font-style:italic"></span>    f64 dvdz <span style="color:#555">=</span> (vUp <span style="color:#555">-</span> v_) <span style="color:#555">/</span> dz;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>    z <span style="color:#555">-=</span> (v_ <span style="color:#555">-</span> v) <span style="color:#555">/</span> dvdz;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>  }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>  <span style="color:#09f;font-style:italic">/// No solution
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span><span style="color:#09f;font-style:italic"></span>  <span style="color:#09f;font-style:italic">///
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span><span style="color:#09f;font-style:italic"></span>  z <span style="color:#555">=</span> NaN;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span>  <span style="color:#069;font-weight:bold">return</span> err;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span>}
</span></span></code></pre></div><h3 id="performance-2">Performance</h3>
<p><strong>16'500 opt/s</strong> is how many American options I can calibrate on my machine. Effectively, we make 3
pricing calls per calibration. It&rsquo;s 170x slower than European calibration with
<a href="http://www.jaeckel.org/">Let&rsquo;s Be Rational</a> by Jaeckel, but much faster comparing to the
finite-difference.</p>
<p><strong>Advanced statistic</strong> with per-call distribution time of <code>calibrateAmerican</code>, collected with
<a href="https://github.com/wolfpld/tracy">Tracy</a> profiler is shown below.</p>
<p><strong>The distribution</strong> indicates that:</p>
<ul>
<li>Deep in- and out-the-money options are cheap to calibrate, as the volatility is the same for
European and American cases, hence the initial guess is already an answer, see the biggest spike
around 10 us region (to the left of the median time).</li>
<li>At-the-money options, on the other hand, require several adjustment steps, hence more
<code>priceAmerican</code> calls. See spikes around 100 us region:</li>
</ul>
<p><img src="calibrateAmerican.webp" alt="Step 3: Statistics"></p>
<h2 id="conclusion">Conclusion</h2>
<p>In order to build advanced hedging and trading strategies, portfolio managers need to quantify
market risk of their portfolios. This is what pricing models are used for.</p>
<p>In this post, we saw how to calibrate the Black-Scholes model to Tesla
<a href="https://github.com/gituliar/tastyhedge/blob/main/mds">American option prices</a> and
<a href="https://home.treasury.gov/resource-center/data-chart-center/interest-rates/TextView">yield curve rates</a>
using C++ and modern quantitative methods and demonstrated how it performs on the modern AMD Ryzen 9
CPU.</p>
<p>Our approach allows to calibrate <strong>16'500 opt/s</strong> on a single CPU core. At this speed we can
calibrate mid prices for the entire market of <strong>1'500'000 options</strong> listed on <strong>5'000 stocks</strong> in
just <strong>45 s</strong>.</p>
<p>Advanced statistic for various functions, collected with <a href="https://github.com/wolfpld/tracy">Tracy</a>
profiler, looks like this:</p>
<p><img src="stats.webp" alt="Summary"></p>

  </div>

  
  <div class="px-2">
    <script src="https://giscus.app/client.js" data-repo="gituliar/tastyhedge.com" data-repo-id="R_kgDOLP4lzg"
      data-category="General" data-category-id="DIC_kwDOLP4lzs4CdfL9" data-mapping="pathname" data-strict="0"
      data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="light_high_contrast"
      data-lang="en" crossorigin="anonymous" async>
      </script>
  </div>
  
</article>


  </div>

  <script>
    document.querySelectorAll('a[href^="http"]').forEach(function (e) {
      e.setAttribute('target', '_blank');
    });
  </script>
</body>

</html>